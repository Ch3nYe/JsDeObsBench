import os
import subprocess
from tqdm import tqdm
import jsonlines
import json
from collections import defaultdict

config_list = {
"code-compact",
"debug-protection",
"name-obfuscation",
"string-obfuscation",
"self-defending",
"control-flow-flattening",
"deadcode-injection",
"1-1",
"1-2",
"1-3",
"1-4",
"1-5",
"1-6",
"1-7",
"combinations/C71-0",
"combinations/C71-1",
"combinations/C71-2",
"combinations/C71-3",
"combinations/C71-4",
"combinations/C71-5",
"combinations/C71-6",
"combinations/C72-0",
"combinations/C72-1",
"combinations/C72-2",
"combinations/C72-3",
"combinations/C72-4",
"combinations/C72-5",
"combinations/C72-6",
"combinations/C72-7",
"combinations/C72-8",
"combinations/C72-9",
"combinations/C72-10",
"combinations/C72-11",
"combinations/C72-12",
"combinations/C72-13",
"combinations/C72-14",
"combinations/C72-15",
"combinations/C72-16",
"combinations/C72-17",
"combinations/C72-18",
"combinations/C72-19",
"combinations/C72-20",
"combinations/C73-0",
"combinations/C73-1",
"combinations/C73-2",
"combinations/C73-3",
"combinations/C73-4",
"combinations/C73-5",
"combinations/C73-6",
"combinations/C73-7",
"combinations/C73-8",
"combinations/C73-9",
"combinations/C73-10",
"combinations/C73-11",
"combinations/C73-12",
"combinations/C73-13",
"combinations/C73-14",
"combinations/C73-15",
"combinations/C73-16",
"combinations/C73-17",
"combinations/C73-18",
"combinations/C73-19",
"combinations/C73-20",
"combinations/C73-21",
"combinations/C73-22",
"combinations/C73-23",
"combinations/C73-24",
"combinations/C73-25",
"combinations/C73-26",
"combinations/C73-27",
"combinations/C73-28",
"combinations/C73-29",
"combinations/C73-30",
"combinations/C73-31",
"combinations/C73-32",
"combinations/C73-33",
"combinations/C73-34",
"combinations/C74-0",
"combinations/C74-1",
"combinations/C74-2",
"combinations/C74-3",
"combinations/C74-4",
"combinations/C74-5",
"combinations/C74-6",
"combinations/C74-7",
"combinations/C74-8",
"combinations/C74-9",
"combinations/C74-10",
"combinations/C74-11",
"combinations/C74-12",
"combinations/C74-13",
"combinations/C74-14",
"combinations/C74-15",
"combinations/C74-16",
"combinations/C74-17",
"combinations/C74-18",
"combinations/C74-19",
"combinations/C74-20",
"combinations/C74-21",
"combinations/C74-22",
"combinations/C74-23",
"combinations/C74-24",
"combinations/C74-25",
"combinations/C74-26",
"combinations/C74-27",
"combinations/C74-28",
"combinations/C74-29",
"combinations/C74-30",
"combinations/C74-31",
"combinations/C74-32",
"combinations/C74-33",
"combinations/C74-34",
"combinations/C75-0",
"combinations/C75-1",
"combinations/C75-2",
"combinations/C75-3",
"combinations/C75-4",
"combinations/C75-5",
"combinations/C75-6",
"combinations/C75-7",
"combinations/C75-8",
"combinations/C75-9",
"combinations/C75-10",
"combinations/C75-11",
"combinations/C75-12",
"combinations/C75-13",
"combinations/C75-14",
"combinations/C75-15",
"combinations/C75-16",
"combinations/C75-17",
"combinations/C75-18",
"combinations/C75-19",
"combinations/C75-20",
"combinations/C76-0",
"combinations/C76-1",
"combinations/C76-2",
"combinations/C76-3",
"combinations/C76-4",
"combinations/C76-5",
"combinations/C76-6",
"combinations/C77-0",
"high-obf-low-perf",
"low-obf-high-perf",
"medium-obf-optimal-perf",
}
examples = defaultdict(list)

with open("./example.js",'r') as f:
    ori_code = f.read()

for config in tqdm(config_list,desc='generating examples'):

    cmd = f"javascript-obfuscator --config ./javascript-obfuscator-configs/{config}.json ./example.js --output ./example.{config}.js"
    run_process = subprocess.run(cmd, shell=True, capture_output=True)
    if run_process.returncode != 0:
        print(f"[!] Failed to exec: {cmd}")
        continue

    with open(f"./example.{config}.js",'r') as f:
        obfuscated_code = f.read()

    os.remove(f"./example.{config}.js")

    examples[config].append({
        "original": ori_code,
        "obfuscated":obfuscated_code,
    })

with open("../deobfuscators/examples.json",'w') as f:
    json.dump(examples,f,indent=4)